var uniqid = require('uniqid');
var htmlspecialchars = require('htmlspecialchars');

const mysql = require('mysql');

const appconfig = require('appconfig');

const dateTime = require('node-datetime');

appconfig.load(mysql);

var adTag = function() {	
	
};

adTag.create = function() { 
	
	var dbCon = appconfig.dbConnection();
	
	this.refNo = uniqid('jdx');

    var adTagObj = {};
    
    adTagObj.aat_ref_no = this.refNo;
    adTagObj.aat_urn = this.urn;
    adTagObj.aat_file_path = this.filePath,
    adTagObj.aat_asset_id = '',
    adTagObj.aat_ad_tag = "<!-- To include additional macros append it after '%ebuy!' in the code --><script type='text/javascript'>document.write('<scri'+'pt'+ \" type='text/javascript' src='https://adserve.2adpro.com/load-creatives/"+this.refNo+"\");document.write('?v=%%VIEW_URL_UNESC%%&c=%%CLICK_URL_ESC%%&lid=%eaid!&cid=%ecid!&oid=%ebuy!');document.write (\"'><\/scr\"+\"ipt>\");</script>";
    adTagObj.aat_ad_tag_preview_url = "";
    adTagObj.aat_creative_type = this.creativeType;

    adTagObj.aat_ad_tag_position = 'inline';

    adTagObj.aat_is_expandable = 0;
    
    var query = dbCon.query('INSERT INTO asset_ad_tags SET ?', adTagObj, function(err, result) {
    	//if (err) throw err;
    	dbCon.end();
    });
    console.log(this.refNo);
    
    var result = {};
    
    result.status="success";
    result.adTag= htmlspecialchars(adTagObj.aat_ad_tag);
    
    return result;	
};

adTag.deliver = function(reply, req) {
	
	var dbCon = appconfig.dbConnection();
	
	var creative = {};

	creative.lId = this.lId;
	creative.cId = this.cId;
	creative.oId = this.oId;
	creative.clickmacro = this.clickMacro;
	
	var trackImprObj = {};
    
	trackImprObj.ati_ref_id = this.refNo;
	trackImprObj.ati_ip = this.userIp;
	trackImprObj.ati_lineitem_id = this.lId;
	trackImprObj.ati_creative_id = this.cId;
	trackImprObj.ati_order_id = this.oId;
	
	var dt = dateTime.create();
	trackImprObj.ati_time = dt.format('Y-m-d H:M:S');

	creative.time = dt.format('YmdHMS');
    
    var query = dbCon.query('INSERT INTO asset_track_impressions SET ?', trackImprObj, function(err, result) {
    	 //if (err) throw err;
    	 //dbCon.end();
    });
	
	var query = dbCon.query('SELECT * FROM asset_ad_tags WHERE aat_ref_no = ?', [this.refNo],function(err, rows){
			
			creative.refId = rows[0].aat_ref_no;
			
			creative.creativeUrl = appconfig.constant.serverUrl + rows[0].aat_file_path;
			
			var creativeFolderPath = rows[0].aat_file_path.substr(0,rows[0].aat_file_path.lastIndexOf('/')+1); 

			var d = require('mobile-detect');
			
			var device = new d(req.headers['user-agent']);

			console.log(device.mobile());	

			var view = rows[0].aat_creative_type;

			if(device.mobile() && device.mobile()!='iPad')
			{
				creative.sliverImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_Sliver_Mdot.png';
				creative.backgroundImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_bg_Mdot.png';
				view += '_mobile';
				creative.creativeUrl = creative.creativeUrl.replace('Dktp','Mdot');
			}
			else
			{
				creative.sliverImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_Sliver_Dktp.png';
				creative.backgroundImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_bg_Dktp.png';
			}
			
			if(this.viewMacro!='%%VIEW_URL_UNESC%%' && this.viewMacro!=''){
				creative.creativeUrl = this.viewMacro + creative.creativeUrl;
			}
			
			console.log(creative);
			
			dbCon.end();
			reply.view(view,creative);			
	});	
};

adTag.load = function(reply, req) {
	
	var dbCon = appconfig.dbConnection();
	
	var creative = {};

	creative.lId = this.lId;
	creative.cId = this.cId;
	creative.oId = this.oId;
	creative.clickmacro = this.clickMacro;
	
	var trackImprObj = {};
    
	trackImprObj.ati_ref_id = this.refNo;
	trackImprObj.ati_ip = this.userIp;
	trackImprObj.ati_lineitem_id = this.lId;
	trackImprObj.ati_creative_id = this.cId;
	trackImprObj.ati_order_id = this.oId;
	
	var dt = dateTime.create();
	trackImprObj.ati_time = dt.format('Y-m-d H:M:S');

	creative.time = dt.format('YmdHMS');
    
    var query = dbCon.query('INSERT INTO asset_track_impressions SET ?', trackImprObj, function(err, result) {
    	
    });
	
	var query = dbCon.query('SELECT * FROM asset_ad_tags WHERE aat_ref_no = ?', [this.refNo],function(err, rows){
			
			creative.refId = rows[0].aat_ref_no;
			
			creative.creativeUrl = appconfig.constant.serverUrl + rows[0].aat_file_path;
			
			var creativeFolderPath = rows[0].aat_file_path.substr(0,rows[0].aat_file_path.lastIndexOf('/')+1); 

			var d = require('mobile-detect');
			
			var device = new d(req.headers['user-agent']);

			console.log(device.mobile());	

			var view = rows[0].aat_creative_type;

			if(device.mobile() && device.mobile()!='iPad')
			{
				creative.sliverImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_Sliver_Mdot.png';
				creative.backgroundImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_bg_Mdot.png';
				view += '_mobile';
				creative.creativeUrl = creative.creativeUrl.replace('Dktp','Mdot');
			}
			else
			{
				creative.sliverImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_Sliver_Dktp.png';
				creative.backgroundImage = appconfig.constant.serverUrl + creativeFolderPath + rows[0].aat_urn + '_bg_Dktp.png';
			}
			
			console.log(creative);
			
			dbCon.end();
			reply.view(view,creative);			
	});	
};

adTag.trackView = function(reply) {
	
	var dbCon = appconfig.dbConnection();
	
	var trackViewObj = {};
    
	trackViewObj.atv_ref_id = this.refId;
	trackViewObj.atv_ip = this.userIp;
	trackViewObj.atv_lineitem_id = this.lineId;
	trackViewObj.atv_creative_id = this.creativeId;
	trackViewObj.atv_order_id = this.orderId;
	
	var dt = dateTime.create();
	trackViewObj.atv_time = dt.format('Y-m-d H:M:S');
    
    var query = dbCon.query('INSERT INTO asset_track_viewability SET ?', trackViewObj, function(err, result) {
    	 //if (err) throw err;
    	 dbCon.end();
    });
    console.log(this.refNo);
};

adTag.trackUserActivity = function(reply) {
	
	var dbCon = appconfig.dbConnection();
	
	var trackViewObj = {};
    
	trackViewObj.atua_ref_id = this.refId;
	trackViewObj.atua_ip = this.userIp;
	trackViewObj.atua_lineitem_id = this.lineId;
	trackViewObj.atua_creative_id = this.creativeId;
	trackViewObj.atua_order_id = this.orderId;
	trackViewObj.atua_event = this.event;
	
	var dt = dateTime.create();
	trackViewObj.atua_time = dt.format('Y-m-d H:M:S');
    
    var query = dbCon.query('INSERT INTO asset_ad_tag_user_activity SET ?', trackViewObj, function(err, result) {
    	 //if (err) throw err;
    	 dbCon.end();
    });
    
    console.log(this.refNo);
};

adTag.trackClick = function(reply) {
	
	var dbCon = appconfig.dbConnection();
	
	var trackClickObj = {};
    
	trackClickObj.atc_ref_id = this.refId;
	trackClickObj.atc_ip = this.userIp;
	trackClickObj.atc_lineitem_id = this.lineId;
	trackClickObj.atc_creative_id = this.creativeId;
	trackClickObj.atc_order_id = this.orderId;
	
	var dt = dateTime.create();
	trackClickObj.atc_time = dt.format('Y-m-d H:M:S');
    
    var query = dbCon.query('INSERT INTO asset_track_clicks SET ?', trackClickObj, function(err, result) {
    	 //if (err) throw err;
    	dbCon.end();
    });
    console.log(this.refNo);
};

adTag.trackVideoPlayed = function(reply) {

        var dbCon = appconfig.dbConnection();

        var trackPlayedObj = {};

        trackPlayedObj.atvp_ref_id = this.refId;
        trackPlayedObj.atvp_ip = this.userIp;
        trackPlayedObj.atvp_lineitem_id = this.lineId;
        trackPlayedObj.atvp_creative_id = this.creativeId;
        trackPlayedObj.atvp_order_id = this.orderId;
	trackPlayedObj.atvp_duration = this.duration;

        var dt = dateTime.create();
        trackPlayedObj.atvp_time = dt.format('Y-m-d H:M:S');

    var query = dbCon.query('INSERT INTO asset_track_video_played SET ?', trackPlayedObj, function(err, result) {
         //if (err) throw err;
         dbCon.end();
    });
    console.log(this.refNo);
};

module.exports = adTag;
